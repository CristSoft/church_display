<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#181c20">
    <title>Church Display - Control</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      /* --- FOOT NAVBAR ACTIVE BUTTON --- */
      .nav-btn.active {
        background: #ffd700 !important;
        color: #23272b !important;
        border-radius: 8px;
        box-shadow: 0 2px 8px #0003;
        transition: background 0.2s, color 0.2s;
      }
      /* Mini proyector igual al proyector real */
      .mini-proyector {
        position: relative;
        background: #181c20;
        border-radius: 12px;
        box-shadow: 0 4px 24px #000a;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mini-proyector-video {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: cover;
        z-index: 0;
      }
      .mini-proyector-content {
        position: relative;
        z-index: 1;
        width: 100%;
        text-align: center;
        color: #fff;
        text-shadow: 0 2px 8px #000, 0 0 2px #ffd700;
        font-family: 'Merriweather', 'Roboto Slab', serif;
        padding: 2em 1em;
        font-size: 2.2em;
        line-height: 1.2;
        user-select: none;
        pointer-events: none;
      }
      .mini-proyector-content .referencia {
        display: block;
        font-size: 0.5em;
        color: #ffd700;
        margin-bottom: 0.5em;
        text-shadow: 0 1px 4px #000;
        font-weight: bold;
        letter-spacing: 1px;
      }
    </style>
</head>
<body>
    <!-- Top Bar Sticky -->
    <div id="topBar" style="position:sticky;top:0;left:0;width:100vw;height:56px;background:#23272b;color:#ffd700;display:flex;align-items:center;justify-content:space-between;z-index:4000;padding:0 1.2em;box-shadow:0 2px 12px #000a;">
      <span id="topBarTitulo" style="font-size:1.3em;font-weight:bold;">Biblia</span>
      <button id="btnCambiarVista" style="background:none;border:none;color:#ffd700;font-size:1.5em;cursor:pointer;outline:none;display:flex;align-items:center;gap:0.5em;">
        <i class="fa-solid fa-list"></i>
        <span style="font-size:0.9em;">Lista</span>
      </button>
    </div>
    
    <button id="abrirProyector">Abrir Ventana de Proyecci√≥n</button>
    <!-- Modal de configuraci√≥n -->
    <div id="configModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
      <div style="background:#23272b; color:#fff; border-radius:10px; padding:2em; min-width:300px; max-width:90vw; box-shadow:0 8px 32px #000a; position:relative;">
        <button id="cerrarConfig" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#ffd700; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="margin-top:0; color:#ffd700;">Configuraci√≥n</h2>
        <div id="sliderFontBibliaContainer" style="margin-bottom:1.5em;">
          <label for="sliderFontsizeBiblia">Tama√±o de fuente vers√≠culos (Biblia):</label><br>
          <input type="range" id="sliderFontsizeBiblia" min="1.5" max="8" step="0.1" value="5">
          <span id="fontsizeValueBiblia">5vw</span>
        </div>
        <div id="sliderFontHimnarioContainer" style="margin-bottom:1.5em;">
          <label for="sliderFontsizeHimnario">Tama√±o de fuente himnos (Himnario):</label><br>
          <input type="range" id="sliderFontsizeHimnario" min="2" max="10" step="0.1" value="5">
          <span id="fontsizeValueHimnario">5vw</span>
        </div>
        <div id="opcionSoloReferencia" style="margin-bottom:1.5em;">
          <label for="switchSoloReferencia">Solo mostrar referencia b√≠blica (modo Biblia):</label>
          <input type="checkbox" id="switchSoloReferencia">
        </div>

      </div>
    </div>
    <hr>
    <!-- Switch para Biblia/Himnario -->
    <!-- <div class="switch-container">
      <label class="switch-label" for="modoSwitch">Himnario</label>
      <input type="checkbox" id="modoSwitch" class="switch-input">
      <span class="slider"></span>
      <label class="switch-label" for="modoSwitch">Biblia</label>
    </div> -->

    <!-- FOOT NAVBAR estilo web app -->
    <nav id="footNavbar" style="position:fixed;bottom:0;left:0;width:100vw;height:64px;background:#23272b;display:flex;justify-content:space-around;align-items:center;z-index:3000;box-shadow:0 -2px 12px #000a;">
      <button id="navHimnario" class="nav-btn" title="Himnario" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-music"></i>
        <span style="font-size:0.7em;">Himnario</span>
      </button>
      <button id="navBiblia" class="nav-btn" title="Biblia" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-book"></i>
        <span style="font-size:0.7em;">Biblia</span>
      </button>
      <button id="navConfig" class="nav-btn" title="Configuraci√≥n" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-cog"></i>
        <span style="font-size:0.7em;">Config</span>
      </button>
    </nav>

    <!-- Contenedor para la Biblia -->
    <div id="controlBiblia">
        <select id="versionBiblia"></select>
        <input type="text" id="buscarLibro" placeholder="Escribe un libro...">
        <div id="sugerenciasLibros"></div>
        <div class="grilla-label">Cap√≠tulos</div>
        <div id="grillaCapitulos"></div>
        <div class="grilla-label">Vers√≠culos</div>
        <div id="grillaVersiculos"></div>
    </div>

    <!-- Contenedor para el Himnario -->
    <div id="controlHimnario" style="display:none;">
        <!-- <div id="audioModeButtons" style="display: flex; gap: 0.5em; margin-bottom: 0.7em; justify-content: flex-start;">
          <button id="btnCantado" class="audio-mode-btn" title="Cantado" type="button">
            <span style="font-size:1.3em;">üé§</span><br><span style="font-size:0.8em;">Cantado</span>
          </button>
          <button id="btnInstrumental" class="audio-mode-btn" title="Instrumental" type="button">
            <span style="font-size:1.3em;">üéπ</span><br><span style="font-size:0.8em;">Instrumental</span>
          </button>
          <button id="btnSoloLetra" class="audio-mode-btn" title="Solo letra" type="button">
            <span style="font-size:1.3em;">üìÑ</span><br><span style="font-size:0.8em;">Solo letra</span>
          </button>
        </div> -->
        <input type="text" id="buscarHimno" placeholder="N¬∫ o T√≠tulo del himno...">
        <div id="listaHimnos"></div>
    </div>
    
    <!-- √Årea de vista previa -->
    <div id="vistaPreviaContainer">
      <div id="vistaPrevia" style="display:block;"></div>
      <div id="vistaProyector" class="mini-proyector" style="display:none;width:100%;height:320px;min-height:180px;max-width:900px;margin:0 auto;position:relative;background:#181c20;border-radius:12px;box-shadow:0 4px 24px #000a;overflow:hidden;display:flex;align-items:center;justify-content:center;">
        <video id="miniProyectorVideo" class="mini-proyector-video" autoplay loop muted playsinline style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;"></video>
        <div id="zonaRetroceder" style="position:absolute;left:0;top:0;width:50%;height:100%;cursor:pointer;z-index:2;"></div>
        <div id="zonaAvanzar" style="position:absolute;right:0;top:0;width:50%;height:100%;cursor:pointer;z-index:2;"></div>
        <div id="proyectorPreviewContent" class="mini-proyector-content" style="width:100%;text-align:center;padding:2em;font-size:2.5em;color:#fff;z-index:1;user-select:none;position:relative;"></div>
      </div>
    </div>

    <!-- Reproductor de audio para himnos -->
    <audio id="reproductorAudio" controls style="width:100%; margin-top:1em;"></audio>

    <footer class="app-footer">
      <button id="anterior">Anterior</button>
      <button id="playHimnoFooter" style="display:none;">‚ñ∂Ô∏è Play</button>
      <button id="siguiente">Siguiente</button>
    </footer>

    <script src="/src/js/dataManager.js"></script>
    <script src="/src/js/main.js"></script>
    
    <!-- Script de prueba temporal -->
    <script>
        console.log('üöÄ Script de prueba iniciado');
        console.log('üì± URL actual:', window.location.href);
        console.log('üîå SocketIO disponible:', typeof io !== 'undefined' ? 'S√≠' : 'No');
        
        // Verificar si main.js se carg√≥ correctamente
        setTimeout(() => {
            console.log('üîç Verificando carga de main.js...');
            console.log('üîå Socket global:', typeof window.socket !== 'undefined' ? 'Existe' : 'No existe');
            console.log('üîå Socket conectado:', typeof window.socket !== 'undefined' && window.socket ? window.socket.connected : 'N/A');
            
            // Verificar si el bot√≥n de prueba existe
            const btnPrueba = document.getElementById('btnPrueba');
            console.log('üß™ Bot√≥n de prueba:', btnPrueba ? 'Existe' : 'No existe');
            
            if (btnPrueba) {
                console.log('üß™ Agregando evento de prueba directo...');
                btnPrueba.addEventListener('click', function() {
                    console.log('üß™ Bot√≥n clickeado (evento directo)');
                    console.log('üîç Estado del socket:', {
                        existe: typeof window.socket !== 'undefined',
                        socket: window.socket,
                        conectado: window.socket ? window.socket.connected : 'N/A'
                    });
                    
                    if (typeof window.socket !== 'undefined' && window.socket && window.socket.connected) {
                        console.log('‚úÖ Socket disponible, enviando mensaje...');
                        window.socket.emit('update_text', {
                            texto: 'üß™ Prueba directa desde HTML',
                            ref: 'Test Directo - ' + new Date().toLocaleTimeString(),
                            soloReferencia: false
                        });
                        console.log('‚úÖ Mensaje enviado (evento directo)');
                        this.textContent = '‚úÖ Enviado!';
                        this.style.background = '#28a745';
                        setTimeout(() => {
                            this.textContent = 'üß™ Probar SocketIO';
                            this.style.background = '#28a745';
                        }, 2000);
                    } else {
                        console.log('‚ùå Socket no disponible (evento directo)');
                        console.log('üîç Detalles del error:', {
                            socketDefinido: typeof window.socket !== 'undefined',
                            socketValor: window.socket,
                            conectado: window.socket ? window.socket.connected : 'N/A'
                        });
                        this.textContent = '‚ùå Error!';
                        this.style.background = '#dc3545';
                        setTimeout(() => {
                            this.textContent = 'üß™ Probar SocketIO';
                            this.style.background = '#28a745';
                        }, 2000);
                    }
                });
                console.log('‚úÖ Evento agregado al bot√≥n');
            } else {
                console.log('‚ùå No se encontr√≥ el bot√≥n de prueba');
            }
        }, 3000); // Aumentamos el tiempo para dar m√°s tiempo a que cargue main.js
    </script>

    <!-- --- ABRIR PROYECTOR EN SEGUNDA PANTALLA Y PANTALLA COMPLETA --- -->
    <script>
    document.getElementById('abrirProyector').addEventListener('click', async function() {
        const proyectorUrl = 'src/proyector.html';
        let features = 'toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=yes';
        let width = window.screen.width;
        let height = window.screen.height;
        let left = 0;
        let top = 0;

        // Intentar usar la Screen Enumeration API si est√° disponible
        if (navigator.getScreens && window.getScreenDetails) {
            try {
                const screens = await window.getScreenDetails();
                if (screens.screens && screens.screens.length > 1) {
                    // Buscar la pantalla secundaria (que no sea la actual)
                    const currentScreen = screens.currentScreen;
                    const secondary = screens.screens.find(s => s !== currentScreen);
                    if (secondary) {
                        width = secondary.width;
                        height = secondary.height;
                        left = secondary.availLeft || secondary.left || 0;
                        top = secondary.availTop || secondary.top || 0;
                    }
                }
            } catch (e) {
                // Si falla, usar la pantalla principal
            }
        } else if (window.screen && window.screen.availWidth && window.screen.availHeight) {
            // Fallback: usar la pantalla principal
            width = window.screen.availWidth;
            height = window.screen.availHeight;
            left = window.screen.availLeft || 0;
            top = window.screen.availTop || 0;
        }

        features += `,width=${width},height=${height},left=${left},top=${top}`;

        // Abrir la ventana del proyector
        const win = window.open(proyectorUrl, 'proyector', features);
        if (win) {
            win.focus();
            // Intentar pantalla completa al cargar
            win.onload = function() {
                if (win.document && win.document.documentElement && win.document.documentElement.requestFullscreen) {
                    win.document.documentElement.requestFullscreen();
                } else if (win.document && win.document.body && win.document.body.requestFullscreen) {
                    win.document.body.requestFullscreen();
                }
            };
        } else {
            alert('No se pudo abrir la ventana del proyector. Por favor, permite los popups.');
        }
    });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // --- L√ìGICA FOOT NAVBAR ---
        const navHimnario = document.getElementById('navHimnario');
        const navBiblia = document.getElementById('navBiblia');
        const navConfig = document.getElementById('navConfig');
        const controlHimnario = document.getElementById('controlHimnario');
        const controlBiblia = document.getElementById('controlBiblia');
        const configModal = document.getElementById('configModal');
        const topBarTitulo = document.getElementById('topBarTitulo');
        const btnCambiarVista = document.getElementById('btnCambiarVista');
        const vistaPreviaContainer = document.getElementById('vistaPreviaContainer');
        const vistaPrevia = document.getElementById('vistaPrevia');
        const vistaProyector = document.getElementById('vistaProyector');
        
        // Estado inicial: Biblia
        let modoActual = 'biblia';
        window.modoActual = modoActual;
        
        function actualizarModo(modo) {
          // Quitar clase activa de todos
          navHimnario.classList.remove('active');
          navBiblia.classList.remove('active');
          // Poner clase activa solo al bot√≥n del modo actual
          if (modo === 'himnario') {
            navHimnario.classList.add('active');
          } else {
            navBiblia.classList.add('active');
          }
          // Usar la funci√≥n global de main.js para cambiar el modo
          if (typeof window.cambiarModoGlobal === 'function') {
            window.cambiarModoGlobal(modo);
          } else {
            // Fallback: l√≥gica local
            if (modo === 'himnario') {
              controlHimnario.style.display = '';
              controlBiblia.style.display = 'none';
            } else {
              controlHimnario.style.display = 'none';
              controlBiblia.style.display = '';
            }
          }
          modoActual = modo;
          window.modoActual = modo;
        }
        
        navHimnario.addEventListener('click', () => actualizarModo('himnario'));
        navBiblia.addEventListener('click', () => actualizarModo('biblia'));
        navConfig.addEventListener('click', () => {
          configModal.style.display = 'flex';
          // Nunca dejar activo el bot√≥n de config
          navHimnario.classList.remove('active');
          navBiblia.classList.remove('active');
        });
        
        // Cerrar modal config
        document.getElementById('cerrarConfig').addEventListener('click', () => {
          configModal.style.display = 'none';
        });
        
        // Inicializar modo
        actualizarModo('biblia');
      });
    </script>
</body>
</html>
