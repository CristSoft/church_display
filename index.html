<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#181c20">
    <title>Church Display - Control</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
    <button id="abrirProyector">Abrir Ventana de Proyecci√≥n</button>
    <!-- Bot√≥n de configuraci√≥n (engranaje) -->
    <button id="btnConfig" style="position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; z-index: 1001;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82-.33 1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .66.39 1.25 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0 1.82.33c.66 0 1.25.39 1.51 1H21a2 2 0 0 1 0 4h-.09c-.66 0-1.25.39-1.51 1z"></path></svg>
    </button>
    <!-- Modal de configuraci√≥n -->
    <div id="configModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
      <div style="background:#23272b; color:#fff; border-radius:10px; padding:2em; min-width:300px; max-width:90vw; box-shadow:0 8px 32px #000a; position:relative;">
        <button id="cerrarConfig" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#ffd700; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="margin-top:0; color:#ffd700;">Configuraci√≥n</h2>
        <div id="sliderFontBibliaContainer" style="margin-bottom:1.5em;">
          <label for="sliderFontsizeBiblia">Tama√±o de fuente vers√≠culos (Biblia):</label><br>
          <input type="range" id="sliderFontsizeBiblia" min="1.5" max="8" step="0.1" value="5">
          <span id="fontsizeValueBiblia">5vw</span>
        </div>
        <div id="sliderFontHimnarioContainer" style="margin-bottom:1.5em;">
          <label for="sliderFontsizeHimnario">Tama√±o de fuente proyector (Himnario):</label><br>
          <input type="range" id="sliderFontsizeHimnario" min="2" max="10" step="0.1" value="5">
          <span id="fontsizeValueHimnario">5vw</span>
        </div>
        <div id="opcionSoloReferencia" style="margin-bottom:1.5em;">
          <label for="switchSoloReferencia">Solo mostrar referencia b√≠blica (modo Biblia):</label>
          <input type="checkbox" id="switchSoloReferencia">
        </div>

      </div>
    </div>
    <hr>
    <!-- Switch para Biblia/Himnario -->
    <!-- <div class="switch-container">
      <label class="switch-label" for="modoSwitch">Himnario</label>
      <input type="checkbox" id="modoSwitch" class="switch-input">
      <span class="slider"></span>
      <label class="switch-label" for="modoSwitch">Biblia</label>
    </div> -->

    <!-- FOOT NAVBAR estilo web app -->
    <nav id="footNavbar" style="position:fixed;bottom:0;left:0;width:100vw;height:64px;background:#23272b;display:flex;justify-content:space-around;align-items:center;z-index:3000;box-shadow:0 -2px 12px #000a;">
      <button id="navHimnario" class="nav-btn" title="Himnario" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-music"></i>
        <span style="font-size:0.7em;">Himnario</span>
      </button>
      <button id="navBiblia" class="nav-btn" title="Biblia" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-book"></i>
        <span style="font-size:0.7em;">Biblia</span>
      </button>
      <button id="navConfig" class="nav-btn" title="Configuraci√≥n" style="background:none;border:none;color:#ffd700;font-size:2em;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;outline:none;">
        <i class="fa-solid fa-cog"></i>
        <span style="font-size:0.7em;">Config</span>
      </button>
    </nav>

    <!-- Contenedor para la Biblia -->
    <div id="controlBiblia">
        <select id="versionBiblia"></select>
        <input type="text" id="buscarLibro" placeholder="Escribe un libro...">
        <div id="sugerenciasLibros"></div>
        <div class="grilla-label">Cap√≠tulos</div>
        <div id="grillaCapitulos"></div>
        <div class="grilla-label">Vers√≠culos</div>
        <div id="grillaVersiculos"></div>
    </div>

    <!-- Contenedor para el Himnario -->
    <div id="controlHimnario" style="display:none;">
        <div id="audioModeButtons" style="display: flex; gap: 0.5em; margin-bottom: 0.7em; justify-content: flex-start;">
          <button id="btnCantado" class="audio-mode-btn" title="Cantado" type="button">
            <span style="font-size:1.3em;">üé§</span><br><span style="font-size:0.8em;">Cantado</span>
          </button>
          <button id="btnInstrumental" class="audio-mode-btn" title="Instrumental" type="button">
            <span style="font-size:1.3em;">üéπ</span><br><span style="font-size:0.8em;">Instrumental</span>
          </button>
          <button id="btnSoloLetra" class="audio-mode-btn" title="Solo letra" type="button">
            <span style="font-size:1.3em;">üìÑ</span><br><span style="font-size:0.8em;">Solo letra</span>
          </button>
        </div>
        <input type="text" id="buscarHimno" placeholder="N¬∫ o T√≠tulo del himno...">
        <div id="listaHimnos"></div>
    </div>
    
    <!-- √Årea de vista previa -->
    <div id="vistaPrevia"></div>

    <!-- Reproductor de audio para himnos -->
    <audio id="reproductorAudio" controls style="width:100%; margin-top:1em;"></audio>

    <footer class="app-footer">
      <button id="anterior">Anterior</button>
      <button id="playHimnoFooter" style="display:none;">‚ñ∂Ô∏è Play</button>
      <button id="siguiente">Siguiente</button>
    </footer>

    <script src="/src/js/dataManager.js"></script>
    <script src="/src/js/main.js"></script>
    
    <!-- Script de prueba temporal -->
    <script>
        console.log('üöÄ Script de prueba iniciado');
        console.log('üì± URL actual:', window.location.href);
        console.log('üîå SocketIO disponible:', typeof io !== 'undefined' ? 'S√≠' : 'No');
        
        // Verificar si main.js se carg√≥ correctamente
        setTimeout(() => {
            console.log('üîç Verificando carga de main.js...');
            console.log('üîå Socket global:', typeof window.socket !== 'undefined' ? 'Existe' : 'No existe');
            console.log('üîå Socket conectado:', typeof window.socket !== 'undefined' && window.socket ? window.socket.connected : 'N/A');
            
            // Verificar si el bot√≥n de prueba existe
            const btnPrueba = document.getElementById('btnPrueba');
            console.log('üß™ Bot√≥n de prueba:', btnPrueba ? 'Existe' : 'No existe');
            
            if (btnPrueba) {
                console.log('üß™ Agregando evento de prueba directo...');
                btnPrueba.addEventListener('click', function() {
                    console.log('üß™ Bot√≥n clickeado (evento directo)');
                    console.log('üîç Estado del socket:', {
                        existe: typeof window.socket !== 'undefined',
                        socket: window.socket,
                        conectado: window.socket ? window.socket.connected : 'N/A'
                    });
                    
                    if (typeof window.socket !== 'undefined' && window.socket && window.socket.connected) {
                        console.log('‚úÖ Socket disponible, enviando mensaje...');
                        window.socket.emit('update_text', {
                            texto: 'üß™ Prueba directa desde HTML',
                            ref: 'Test Directo - ' + new Date().toLocaleTimeString(),
                            soloReferencia: false
                        });
                        console.log('‚úÖ Mensaje enviado (evento directo)');
                        this.textContent = '‚úÖ Enviado!';
                        this.style.background = '#28a745';
                        setTimeout(() => {
                            this.textContent = 'üß™ Probar SocketIO';
                            this.style.background = '#28a745';
                        }, 2000);
                    } else {
                        console.log('‚ùå Socket no disponible (evento directo)');
                        console.log('üîç Detalles del error:', {
                            socketDefinido: typeof window.socket !== 'undefined',
                            socketValor: window.socket,
                            conectado: window.socket ? window.socket.connected : 'N/A'
                        });
                        this.textContent = '‚ùå Error!';
                        this.style.background = '#dc3545';
                        setTimeout(() => {
                            this.textContent = 'üß™ Probar SocketIO';
                            this.style.background = '#28a745';
                        }, 2000);
                    }
                });
                console.log('‚úÖ Evento agregado al bot√≥n');
            } else {
                console.log('‚ùå No se encontr√≥ el bot√≥n de prueba');
            }
        }, 3000); // Aumentamos el tiempo para dar m√°s tiempo a que cargue main.js
    </script>

    <!-- --- ABRIR PROYECTOR EN SEGUNDA PANTALLA Y PANTALLA COMPLETA --- -->
    <script>
    document.getElementById('abrirProyector').addEventListener('click', async function() {
        const proyectorUrl = 'src/proyector.html';
        let features = 'toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=yes';
        let width = window.screen.width;
        let height = window.screen.height;
        let left = 0;
        let top = 0;

        // Intentar usar la Screen Enumeration API si est√° disponible
        if (navigator.getScreens && window.getScreenDetails) {
            try {
                const screens = await window.getScreenDetails();
                if (screens.screens && screens.screens.length > 1) {
                    // Buscar la pantalla secundaria (que no sea la actual)
                    const currentScreen = screens.currentScreen;
                    const secondary = screens.screens.find(s => s !== currentScreen);
                    if (secondary) {
                        width = secondary.width;
                        height = secondary.height;
                        left = secondary.availLeft || secondary.left || 0;
                        top = secondary.availTop || secondary.top || 0;
                    }
                }
            } catch (e) {
                // Si falla, usar la pantalla principal
            }
        } else if (window.screen && window.screen.availWidth && window.screen.availHeight) {
            // Fallback: usar la pantalla principal
            width = window.screen.availWidth;
            height = window.screen.availHeight;
            left = window.screen.availLeft || 0;
            top = window.screen.availTop || 0;
        }

        features += `,width=${width},height=${height},left=${left},top=${top}`;

        // Abrir la ventana del proyector
        const win = window.open(proyectorUrl, 'proyector', features);
        if (win) {
            win.focus();
            // Intentar pantalla completa al cargar
            win.onload = function() {
                if (win.document && win.document.documentElement && win.document.documentElement.requestFullscreen) {
                    win.document.documentElement.requestFullscreen();
                } else if (win.document && win.document.body && win.document.body.requestFullscreen) {
                    win.document.body.requestFullscreen();
                }
            };
        } else {
            alert('No se pudo abrir la ventana del proyector. Por favor, permite los popups.');
        }
    });
    </script>

    <script>
      // --- L√ìGICA FOOT NAVBAR ---
      const navHimnario = document.getElementById('navHimnario');
      const navBiblia = document.getElementById('navBiblia');
      const navConfig = document.getElementById('navConfig');
      const controlHimnario = document.getElementById('controlHimnario');
      const controlBiblia = document.getElementById('controlBiblia');
      const configModal = document.getElementById('configModal');
      
      // Estado inicial: Biblia
      let modoActual = 'biblia';
      
      function actualizarModo(modo) {
        // Actualizar colores del navbar
        if (modo === 'himnario') {
          navHimnario.style.color = '#fff';
          navBiblia.style.color = '#ffd700';
        } else {
          navHimnario.style.color = '#ffd700';
          navBiblia.style.color = '#fff';
        }
        
        // Usar la funci√≥n global de main.js para cambiar el modo
        if (typeof window.cambiarModoGlobal === 'function') {
          window.cambiarModoGlobal(modo);
        } else {
          console.warn('‚ö†Ô∏è Funci√≥n cambiarModoGlobal no disponible, usando l√≥gica local');
          // Fallback: l√≥gica local
          if (modo === 'himnario') {
            controlHimnario.style.display = '';
            controlBiblia.style.display = 'none';
          } else {
            controlHimnario.style.display = 'none';
            controlBiblia.style.display = '';
          }
          modoActual = modo;
          
          // Enviar mensaje al proyector para cambiar el fondo de pantalla
          setTimeout(() => {
            if (typeof window.socket !== 'undefined' && window.socket && window.socket.connected) {
              const videoSrc = modo === 'himnario' ? '/src/assets/videos/himno-bg.mp4' : '/src/assets/videos/verso-bg.mp4';
              window.socket.emit('change_mode', { videoSrc: videoSrc });
              console.log('üì§ Enviando cambio de modo al proyector:', { modo, videoSrc });
            } else {
              console.warn('‚ö†Ô∏è Socket no disponible para enviar cambio de modo');
            }
          }, 100); // Peque√±o retraso para asegurar que el socket est√© disponible
        }
      }
      
      navHimnario.addEventListener('click', () => actualizarModo('himnario'));
      navBiblia.addEventListener('click', () => actualizarModo('biblia'));
      navConfig.addEventListener('click', () => {
        configModal.style.display = 'flex';
      });
      
      // Cerrar modal config
      document.getElementById('cerrarConfig').addEventListener('click', () => {
        configModal.style.display = 'none';
      });
      
      // Inicializar modo
      actualizarModo('biblia');
    </script>
</body>
</html>
